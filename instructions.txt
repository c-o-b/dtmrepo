dtmrepo

dtmrepo is a mrepo replacement. The main difference between the two is that mrepo uses RHN classic subscription to synchronise with Red Hat while dtmrepo uses subscription-manager. They handle non-RHN repos almost the same way so http, ftp and file-based repos should work with dtmrepo.

I. Prerequisites

Unlike mrepo, dtmrepo relies heavily on external yum utilities which means that repositories must be properly configured before they can be utilised. It is not enough that you define an epel configuration, you need to make sure that the epel yum repo is also configured. This restriction is further explained in the Configuration section below.

If you need to sync with Red Hat you will require a valid subscription. You will also need to install the subscription-manager package.

II. Installation

"Installation" is easy:

cp dtmrepo dtmrepo-globalconf dtmrepo-repoconf /usr/local/sbin
chmod +x /usr/local/sbin/dtmrepo*
cp dtmrepo.conf /etc
mkdir /etc/dtmrepo.conf.d
mkdir /etc/dtmrepo.repos.d
mkdir /var/dtmrepo
cp dtmrepo-yum.conf /etc/dtmrepo.repos.d

You may now prepare the web server:

yum -y install httpd
cp httpd-dtmrepo.conf /etc/httpd/conf.d
cd /var/www && ln -s ../dtmrepo
chkconfig httpd on
service httpd start

III. Configuration

If you wish to synchronise Red Hat packages, make sure that your dtmrepo server is registered and subscribed. Using the default dtmrepo.conf, perform the following:

    dtmrepo -i

This will register and initialise dtmrepo. During registration it will ask for your Red Hat credentials and attempt to subscribe your system using subscription-manager. It will also configure /etc/rhsm/rhsm.conf such that dtmrepo will internally manage the repositories defined under /etc/yum.repos.d. Once the initialisation is finished you may add other repos (e.g. epel) that you want to sync in a separate .repo file in /etc/yum.repos.d.


    The main configuration file for dtmrepo is /etc/dtmrepo.conf. Below are the default settings:

    [global]
    rootdir = /var/dtmrepo
    confdir = /etc/dtmrepo.conf.d
    yumconf = /etc/dtmrepo.repos.d/dtmrepo-yum.conf
    keep = 3
    arch = x86_64
    protect = java,firefox
    subscribed = 1

    At the moment there is just one section called [global]. This section is required.
        rootdir â€“ this is the where packages are stored. Each distro will have its own subdirectory.
        confdir -- this is where distro specific configuration files are located
        yumconf -- custom yum configuration for dtmrepo
        keep -- the number of package versions to keep. This is probably the most sought-after feature that is missing in mrepo.
        arch -- default distro architecture. This can be overridden in the individual distro configuration files defined under confdir.
        protect -- comma separated list of package patterns that will not be deleted even if they are old; patterns are compatible with grep
        subscribed -- the system is subscribed and wants to sync from Red Hat


    Sample dtmrepo-yum.conf:

    [main]
    cachedir=/var/cache/dtmrepo/
    logfile=/var/log/dtmrepo.log
    obsoletes=1
    plugins=1
    reposdir=/etc/dtmrepo.repos.d



    The /etc/dtmrepo.conf.d/

    This directory contains distro-specific configuration files. The configuration files must have an extension of .conf. The filename defines the distro name. For example, the distro rhel5s-x86_64 will have a configuration file called /etc/dtmrepo.conf.d/rhel5s-x86_64.conf. The distro name also corresponds to the directory /var/dtmrepo/distro where repo packages are saved during synchronisation.

    Below is a sample distro.conf configuration file:
    [control]
    releasever = 5Server
    arch = x86_64
    keep = 2

    [repos]
    os = rhel-5-server-rpms
    optional = rhel-5-server-optional-rpms
    supplementary = rhel-5-server-supplementary-rpms
    epel = epel-5-x86_64
    foo = local:/var/dtmrepo/foo/el5/x86_64

    There are two sections: [control] and [repos]. The [control] section may override some of the global configuration options. In the example above it overrides the the number of package versions to keep. The [repos] section defines the different repositories that will be synced. The format is "targetdir = repoid". The targetdir corresponds to the directory /var/dtmrepo/rhel5s-x86_64/targetdir and repoid is a real yum repository that is preconfigured under /etc/dtmrepo.repos.d/.

    IMPORTANT: For all distros that rely on Red Hat subscription-manager, the "releasever" and "arch" variables NEED to be defined.

    At the moment there are two types of repoid that is accepted by dtmrepo. The first type is the most common where the repoid is a real yum repo. In the example above, the line epel = epel-5-x86_64 implies that epel-5-x86_64 is a yum repo defined under /etc/dtmrepo.repos.d/ like this:

    [epel-5-x86_64]
    name=epel-5
    mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-5&arch=x86_64
    failovermethod=priority
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-5

    Put the repo configurations under the directory specified in "reposdir" of the custom yum configuration specified in "yumconf" of /etc/dtmrepo.conf.

    The second type of repoid is not a real repository but just a collection of packages stored in a directory somewhere. This is specified by the identifier local:. In the example, /var/dtmrepo/foo/el5/x86_64 need not contain a repodata.If the directory already exists where it's supposed to be under repodata (i.e. /var/dtmrepo/rhel5s-x86_64/foo) then it is left untouched otherwise a symlink that points to the source directory is created under the said repodata.

IV. Usage

dtmrepo accepts several commandline options namely:

    -a : sync all packages. Useful when you are starting to build your repo server. By default only newer packages are synced
    -d : comma-separated list of distros to process. If not specified then all distros are processed
    -r : comma-separated list of repos to process. If not specified then all repos are processed
    -u : sync packages
    -g : generate repodata
    -p : purge undeclared repo directories
    -f : force the operation. Normally, dtmrepo will not attempt to generate new repodata if it's newer than any package in the repo.
    -x : autofix. Red Hat subscription-manager automatically updates the subscription certificate. This option automatically updates master.repo with the new cert.
    -i : register and initialise the system. Only relevant if you wish to sync with Red Hat. Use it if the sanity check reports any error. It is smart enough to fix only the errors encountered.
    -v : run in verbose mode. Useful when dtmrepo seems to ignore you.

V. Usage Examples

    dtmrepo -?
        show help

    dtmrepo -c
        perform sanity checks

    dtmrepo -i
        register and initialise the system

    dtmrepo -augfv
        sync all packages and force the generation of repodata for all repos and all distros and show me what you're doing. Useful during initial build of a dtmrepo server.

    dtmrepo -ug -r epel
        sync and generate repo data for epel on all distros

    dtmrepo -u -r foo,bar
        sync foo and bar repos on all distros

    dtmrepo -u -d rhel5s
        sync only the rhel5s distro

    dtmrepo -u -d rhel5s,rhel6s
        sync all repos on rhel5s and rhel6s distros

    dtmrepo -fg -r foo -d rhel5s
        generate repodata for the foo repo in the rhel5s distro

    dtmrepo -xug
        a useful command for automatic updates via cron

    dtmrepo -p -d rhel5s
        purge all repo directories that are not declared in the rhel5s distro config file

    dtmrepo -p
        purge all repo directories that are not declared in the distro config files

VI. Tips

    1. Make sure that all the repo configurations in /etc/yum.repos.d are disabled (enabled=0) except for the self referencing repo mentioned in #2 below.

    2. To update the dtmrepo server itself, create a self-referencing repo configuration under /etc/yum.repos.d. Example:

        [self-os]
        name=self-os
        baseurl=file:///var/dtmrepo/rhel6s-x86_64/os
        gpgcheck=0

    3. If you are synchronising from a repo that changes frequently you may want to disable http caching in /etc/yum.conf. This allows dtmrepo to immediately detect and sync new packages.

        /etc/yum.conf:

        http_caching=none

VII. genrepoconfig Tool

    This tool is useful for generating repo configuration files for other Red Hat releases. By default, it uses /etc/yum.repos.d/redhat-dtmrepo.repo as reference but you can also pass another repo as a fourth parameter.
For example, if the dtmrepo server is running EL6 but you want to pull EL5 or EL7 packages as well, you can create repo configs like so:

    genrepoconfig 5 Server x86_64 > /etc/dtmrepo.repos.d/redhat5.repo
    genrepoconfig 7 Server x86_64 > /etc/dtmrepo.repos.d/redhat7.repo
    genrepoconfig 7 Server x86_64 /etc/yum.repos.d/redhat.repo > /etc/dtmrepo.repos.d/redhat7.repo

    From here you can select what repos to sync after creating your custom configs under /etc/dtmrepo.conf.d/.

VIII. Limitations

    1. To sync multiple different versions and types of RHEL (i.e. 5Server, 6Workstation, etc...) from one dtmrepo server, you will need to get the correct product certificates from Red Hat otherwise dtmrepo will only sync the RHEL product type that dtmrepo is running in. Once you have the product certificates installed "dtmrepo -x" should automatically take care of the repository configuration under /etc/yum.repos.d/redhat-dtmrepo.repo. Of course this restriction does not affect non-Red Hat repos.

    2. dtmrepo has problems dealing with broken downloads. If your internet connection is faulty and packages are not downloaded completely then the repodata generation may fail. The only way to fix this is to perform another fetch (dtmrepo -u) hoping that the packages will download completely this time. I have encountered instances where because of our pathetic internet link, the downloaded packages are zero-byte files.

    3. There's no ISO mounting support yet, unlike mrepo. I don't find it critical for my use.
